<html lang="ja">

<head>
  <meta charset="utf-8" />
  <!--
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  -->
  <title>クイズ</title>
  <script type="text/javascript">
    const retry_interval = 200;
    const retry_count = 30 * 1000 / retry_interval;
    var quizes;
    var intervalID;
    var correct_number = 0;

    function clearAllChildElements(element) {
      while (element.childElementCount > 0) {
        element.removeChild(element.lastChild);
      }
    }
    function htmlDecode(input) {
      var e = document.createElement('textarea');
      e.innerHTML = input;
      return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }
    function shuffleArray(array) {
      let currentIndex = array.length;
      let temporaryValue, randomIndex;

      while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }
      return array;
    }

    function showQuiz(quiz_no) {
      if (!quizes)
        return;

      if (quiz_no > (quizes.length - 1)) {
        clearAllChildElements(document.getElementById('answer_area'));
        document.getElementById('quiz_title').innerText = "あなたの正答数は" + correct_number + "です！！";
        document.getElementById('quiz_category').innerText = "";
        document.getElementById('quiz_difficulty').innerText = "";
        document.getElementById('quiz_description').innerText = "再度チャレンジしたい場合は以下をクリック！！";
        document.getElementById('form_button_main').value = "ホームに戻る";
        document.getElementById('form_button_main').style.display = "block"; // ボタンを表示する
        return;
      }

      clearAllChildElements(document.getElementById('answer_area'));

      document.getElementById('quiz_title').innerText = "問題" + (quiz_no + 1);
      document.getElementById('quiz_category').innerText = "[ジャンル] " + htmlDecode(quizes[quiz_no]['category']);
      document.getElementById('quiz_difficulty').innerText = "[難易度] " + htmlDecode(quizes[quiz_no]['difficulty']);
      document.getElementById('quiz_description').innerText = htmlDecode(quizes[quiz_no]['question']);

      var answer_buttons = new Array();

      const correct_button = document.createElement("input");
      correct_button.type = "button";
      correct_button.value = htmlDecode(quizes[quiz_no]['correct_answer']);
      correct_button.correct = true;
      correct_button.onclick = function () {
        correct_number++;
        showQuiz(quiz_no + 1);
      }
      answer_buttons.push(correct_button);

      quizes[quiz_no]['incorrect_answers'].forEach(incorrect_answer => {
        const incorrect_button = document.createElement("input");
        incorrect_button.type = "button";
        incorrect_button.value = htmlDecode(incorrect_answer);
        incorrect_button.correct = false;
        incorrect_button.onclick = function () {
          showQuiz(quiz_no + 1);
        }
        answer_buttons.push(incorrect_button);
      });

      answer_buttons = shuffleArray(answer_buttons);
      answer_buttons.forEach((answer_button) => {
        document.getElementById('answer_area').appendChild(answer_button);
      });
    }

    function fetchQuizes() {
      fetch('/quizes')
        .then((response) => {
          if (!response.ok)
            throw new Error('クイズ取得の際にアクセスエラーが発生しました。');
          return response.json();
        })
        .then((json) => {
          if (!json) {
            if (retry_count > 0) {
              retry_cout -= 1;
              return;
            }
            else
              throw new Error('クイズ取得データにエラーがありました。');
          }
          if (json.length < 1) {
            if (retry_count > 0) {
              retry_cout -= 1;
              return;
            }
            else
              throw new Error('クイズが1つも取得できませんでした。');
          }
          quizes = shuffleArray(json);
          window.clearInterval(intervalID);
          showQuiz(0);
        })
        .catch((error) => {
          alert(error);
        });
    }

    function onClickMain() {
      correct_number = 0;
      quizes = undefined;
      document.getElementById('form_button_main').style.display = "none"; // ボタンを消す
      document.getElementById('quiz_title').innerText = "取得中";
      document.getElementById('quiz_description').innerText = "少々お待ち下さい";
      intervalID = window.setInterval(fetchQuizes, retry_interval);
    }
  </script>
</head>

<body onload="">
  <h1 id="quiz_title">ようこそ</h1>
  <p id="quiz_category"></p>
  <p id="quiz_difficulty"></p>
  <hr />
  <p id="quiz_description">以下のボタンをクリック</p>
  <hr />
  <form name="main">
    <input type="button" value="開始" id="form_button_main" onclick="onClickMain()"></input>
    <div id="answer_area"></div>
  </form>


  <!--
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
    integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
    crossorigin="anonymous"></script>
  -->
</body>

</html>